<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>corpkit.interrogator &mdash; corpkit-docs 1.74 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.74',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="corpkit-docs 1.74 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for corpkit.interrogator</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python</span>

<div class="viewcode-block" id="interrogator"><a class="viewcode-back" href="../../corpkit.html#corpkit.interrogator.interrogator">[docs]</a><span class="k">def</span> <span class="nf">interrogator</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                <span class="n">search</span><span class="p">,</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;any&#39;</span><span class="p">,</span> 
                <span class="n">show</span> <span class="o">=</span> <span class="s">&#39;words&#39;</span><span class="p">,</span>
                <span class="n">exclude</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">case_sensitive</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">lemmatise</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                <span class="n">titlefilter</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                <span class="n">lemmatag</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                <span class="n">spelling</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                <span class="n">phrases</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                <span class="n">dep_type</span> <span class="o">=</span> <span class="s">&#39;collapsed-ccprocessed-dependencies&#39;</span><span class="p">,</span>
                <span class="n">quicksave</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">printstatus</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                <span class="n">root</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">df1_always_df</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">just_speakers</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">excludemode</span> <span class="o">=</span> <span class="s">&#39;any&#39;</span><span class="p">,</span>
                <span class="n">searchmode</span> <span class="o">=</span> <span class="s">&#39;all&#39;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Interrogate a corpus of texts for a lexicogrammatical phenomenon</span>

<span class="sd">    :param path: Path to a corpus</span>
<span class="sd">    :type path: str -- corpus path; list of strings -- list of paths</span>
<span class="sd">    </span>
<span class="sd">    :param search: What query should be matching</span>
<span class="sd">        - t/tregex</span>
<span class="sd">        - w/word</span>
<span class="sd">        - l/lemma</span>
<span class="sd">        - f/function</span>
<span class="sd">        - g/governor</span>
<span class="sd">        - d/dependent</span>
<span class="sd">        - p/pos</span>
<span class="sd">        - i/index</span>
<span class="sd">        - n/ngrams</span>
<span class="sd">    :type search: str, or, for dependencies, a dict like {&#39;w&#39;: &#39;help&#39;, &#39;p&#39;: r&#39;^V&#39;}</span>

<span class="sd">    :param searchmode: Return results matching any/all criteria</span>
<span class="sd">    :type searchmode: str (&#39;any&#39;/&#39;all&#39;)</span>

<span class="sd">    :param exclude: The inverse of `search`, removing results from search</span>
<span class="sd">    :type exclude: dict -- {&#39;l&#39;: &#39;be&#39;}</span>

<span class="sd">    :param excludemode: Exclude results matching any/all criteria</span>
<span class="sd">    :type excludemode: str (&#39;any&#39;/&#39;all&#39;)</span>
<span class="sd">    </span>
<span class="sd">    :param query: A search query for the interrogation</span>
<span class="sd">    :type query: str -- regex/Tregex pattern; dict -- ``{name: pattern}``; list -- word list to match</span>

<span class="sd">    :param show: What to output. If multiple strings are passed, results will be colon-separated, in order</span>
<span class="sd">        - t/tree</span>
<span class="sd">        - w/word</span>
<span class="sd">        - l/lemma</span>
<span class="sd">        - g/governor</span>
<span class="sd">        - d/dependent</span>
<span class="sd">        - f/function</span>
<span class="sd">        - p/pos</span>
<span class="sd">        - i/index</span>
<span class="sd">        - a/distance from root</span>
<span class="sd">    :type show: list of strings</span>

<span class="sd">    :param lemmatise: Do lemmatisation on results</span>
<span class="sd">    :type lemmatise: bool</span>
<span class="sd">        </span>
<span class="sd">    :param lemmatag: Explicitly pass a pos to lemmatiser (generally when data is unparsed)</span>
<span class="sd">    :type lemmatag: False/&#39;n&#39;/&#39;v&#39;/&#39;a&#39;/&#39;r&#39;</span>
<span class="sd">    </span>
<span class="sd">    :param titlefilter: Strip &#39;mr, &#39;the&#39;, &#39;dr.&#39; etc. from multiword results (turns &#39;phrases&#39; on)</span>
<span class="sd">    :type titlefilter: bool</span>
<span class="sd">    </span>
<span class="sd">    :param spelling: Convert all to U.S. or U.K. English</span>
<span class="sd">    :type spelling: False/&#39;US&#39;/&#39;UK&#39;</span>
<span class="sd">        </span>
<span class="sd">    :param phrases: Use if your expected results are multiword (e.g. searching for NP, with</span>
<span class="sd">                    show as &#39;w&#39;), and thus need tokenising</span>
<span class="sd">    :type phrases: bool</span>
<span class="sd">        </span>
<span class="sd">    :param dep_type: The kind of Stanford CoreNLP dependency parses you want to use:</span>
<span class="sd">    :type dep_type: str -- &#39;basic-dependencies&#39;/&#39;a&#39;, &#39;collapsed-dependencies&#39;/&#39;b&#39;, &#39;collapsed-ccprocessed-dependencies&#39;/&#39;c&#39;</span>
<span class="sd">    </span>
<span class="sd">    :param quicksave: Save result as pickle to saved_interrogations/*quicksave* on completion</span>
<span class="sd">    :type quicksave: str</span>
<span class="sd">    </span>
<span class="sd">    :param gramsize: size of ngrams (default 2)</span>
<span class="sd">    :type gramsize: int</span>

<span class="sd">    :param split_contractions: make &quot;don&#39;t&quot; et al into two tokens</span>
<span class="sd">    :type split_contractions: bool</span>

<span class="sd">    :param num_proc: how many parallel processes to run -- default is the number of cores</span>
<span class="sd">    :type num_proc: int</span>

<span class="sd">    :returns: A named tuple, with ``.query``, ``.results``, ``.totals`` attributes. </span>
<span class="sd">              If multiprocessing is invoked, result may be a dict containing corpus names, queries or speakers as keys.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">corpkit</span>
    <span class="kn">from</span> <span class="nn">corpkit.process</span> <span class="kn">import</span> <span class="n">add_corpkit_to_path</span>
    <span class="kn">from</span> <span class="nn">corpkit.process</span> <span class="kn">import</span> <span class="n">tregex_engine</span>
    <span class="kn">from</span> <span class="nn">corpkit.process</span> <span class="kn">import</span> <span class="n">add_nltk_data_to_nltk_path</span>
    
    <span class="c"># some non-Python resources need to explicitly be added to path</span>
    <span class="n">add_corpkit_to_path</span><span class="p">()</span>

    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">import</span> <span class="nn">signal</span>
    <span class="kn">import</span> <span class="nn">gc</span>

    <span class="kn">import</span> <span class="nn">collections</span>
    <span class="kn">import</span> <span class="nn">warnings</span>
    <span class="kn">import</span> <span class="nn">nltk</span>
    <span class="kn">import</span> <span class="nn">numpy</span>

    <span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
    <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">localtime</span><span class="p">,</span> <span class="n">strftime</span>
    <span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span>

    <span class="kn">from</span> <span class="nn">corpkit.tests</span> <span class="kn">import</span> <span class="n">check_pytex</span><span class="p">,</span> <span class="n">check_t_kinter</span>
    <span class="kn">from</span> <span class="nn">corpkit.textprogressbar</span> <span class="kn">import</span> <span class="n">TextProgressBar</span>

    <span class="kn">import</span> <span class="nn">dictionaries</span>
    <span class="kn">from</span> <span class="nn">dictionaries.word_transforms</span> <span class="kn">import</span> <span class="p">(</span><span class="n">wordlist</span><span class="p">,</span> 
                                              <span class="n">usa_convert</span><span class="p">,</span> 
                                              <span class="n">taglemma</span><span class="p">)</span>

    <span class="c"># nltk data path for tokeniser/lemmatiser</span>
    <span class="k">if</span> <span class="s">&#39;nltk_data_path&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;nltk_data_path&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nltk</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">nltk</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;nltk_data_path&#39;</span><span class="p">])</span>
    <span class="n">locdir</span> <span class="o">=</span> <span class="s">&#39;/Users/daniel/work/corpkit/nltk_data&#39;</span>
    <span class="k">if</span> <span class="n">locdir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nltk</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="n">nltk</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">locdir</span><span class="p">)</span>

    <span class="c"># prefer ipython to python if the user has it</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">clear_output</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="c"># check for gui, pythontex</span>
    <span class="n">tk</span> <span class="o">=</span> <span class="n">check_t_kinter</span><span class="p">()</span>
    <span class="n">have_python_tex</span> <span class="o">=</span> <span class="n">check_pytex</span><span class="p">()</span>

    <span class="c"># multiprocessing progress bar</span>
    <span class="k">if</span> <span class="s">&#39;denominator&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;denominator&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="s">&#39;startnum&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">startnum</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;startnum&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">startnum</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># determine if multiquery</span>
    <span class="n">is_multiquery</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
        <span class="n">is_multiquery</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="s">&#39;postounts&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">spelling</span> <span class="o">=</span> <span class="s">&#39;UK&#39;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">:</span>
        <span class="n">is_multiquery</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">just_speakers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">just_speakers</span> <span class="o">==</span> <span class="s">&#39;each&#39;</span><span class="p">:</span>
            <span class="n">is_multiquery</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">just_speakers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">just_speakers</span> <span class="o">!=</span> <span class="s">&#39;each&#39;</span><span class="p">:</span>
                <span class="n">just_speakers</span> <span class="o">=</span> <span class="p">[</span><span class="n">just_speakers</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">just_speakers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">just_speakers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">is_multiquery</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># regex type</span>
    <span class="n">retype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;hello, world&#39;</span><span class="p">))</span>

    <span class="c"># just for me: convert spelling automatically for bipolar</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_multiquery</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;postcounts&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">spelling</span> <span class="o">=</span> <span class="s">&#39;UK&#39;</span>

    <span class="c"># don&#39;t print so much stdout in the GUI</span>
    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">shouldprint</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shouldprint</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># run pmultiquery if so</span>
    <span class="k">if</span> <span class="n">is_multiquery</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">corpkit.multiprocess</span> <span class="kn">import</span> <span class="n">pmultiquery</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> 
              <span class="s">&#39;search&#39;</span><span class="p">:</span> <span class="n">search</span><span class="p">,</span>
              <span class="s">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
              <span class="s">&#39;show&#39;</span><span class="p">:</span> <span class="n">show</span><span class="p">,</span>
              <span class="s">&#39;lemmatise&#39;</span><span class="p">:</span> <span class="n">lemmatise</span><span class="p">,</span> 
              <span class="s">&#39;titlefilter&#39;</span><span class="p">:</span> <span class="n">titlefilter</span><span class="p">,</span> 
              <span class="s">&#39;lemmatag&#39;</span><span class="p">:</span> <span class="n">lemmatag</span><span class="p">,</span> 
              <span class="s">&#39;print_info&#39;</span><span class="p">:</span> <span class="n">shouldprint</span><span class="p">,</span> 
              <span class="s">&#39;spelling&#39;</span><span class="p">:</span> <span class="n">spelling</span><span class="p">,</span> 
              <span class="s">&#39;phrases&#39;</span><span class="p">:</span> <span class="n">phrases</span><span class="p">,</span> 
              <span class="s">&#39;dep_type&#39;</span><span class="p">:</span> <span class="n">dep_type</span><span class="p">,</span> 
              <span class="s">&#39;quicksave&#39;</span><span class="p">:</span> <span class="n">quicksave</span><span class="p">,</span> 
              <span class="s">&#39;df1_always_df&#39;</span><span class="p">:</span> <span class="n">df1_always_df</span><span class="p">,</span>
              <span class="s">&#39;just_speakers&#39;</span><span class="p">:</span> <span class="n">just_speakers</span><span class="p">,</span> 
              <span class="s">&#39;root&#39;</span><span class="p">:</span> <span class="n">root</span><span class="p">,}</span>
        
        <span class="k">if</span> <span class="s">&#39;note&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;note&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s">&#39;note&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;note&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s">&#39;num_proc&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">d</span><span class="p">[</span><span class="s">&#39;num_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;num_proc&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">pmultiquery</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>

    <span class="k">if</span> <span class="s">&#39;paralleling&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">paralleling</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;paralleling&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">paralleling</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># multiple progress bars when multiprocessing</span>
    <span class="n">par_args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">blessings</span> <span class="kn">import</span> <span class="n">Terminal</span>
        <span class="n">term</span> <span class="o">=</span> <span class="n">Terminal</span><span class="p">()</span>
        <span class="n">par_args</span><span class="p">[</span><span class="s">&#39;terminal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">term</span>
        <span class="n">par_args</span><span class="p">[</span><span class="s">&#39;linenum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">paralleling</span>

    <span class="n">the_time_started</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">)</span>
    
    <span class="c"># check if we are in ipython</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">getoutput</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">have_ipython</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="n">have_ipython</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">unsplitter</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;unsplit contractions and apostophes from tokenised text&quot;&quot;&quot;</span>
        <span class="n">unsplit</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">unsplit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">t</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">):</span>
                <span class="n">rejoined</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">lst</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">])</span>
                <span class="n">unsplit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rejoined</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="n">unsplit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unsplit</span>

    <span class="k">def</span> <span class="nf">animator</span><span class="p">(</span><span class="n">progbar</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tot_string</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">linenum</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">terminal</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                 <span class="n">init</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Animates progress bar in unique position in terminal</span>
<span class="sd">        Multiple progress bars not supported in jupyter yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">textprogressbar</span> <span class="kn">import</span> <span class="n">TextProgressBar</span>
            <span class="k">return</span> <span class="n">TextProgressBar</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dirname</span> <span class="o">=</span> <span class="n">tot_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">linenum</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">terminal</span><span class="o">.</span><span class="n">location</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">terminal</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="p">(</span><span class="n">linenum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">tot_string</span><span class="p">:</span>
                    <span class="n">progbar</span><span class="o">.</span><span class="n">animate</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">tot_string</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">progbar</span><span class="o">.</span><span class="n">animate</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tot_string</span><span class="p">:</span>
                <span class="n">progbar</span><span class="o">.</span><span class="n">animate</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">tot_string</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">progbar</span><span class="o">.</span><span class="n">animate</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pause on ctrl+c, rather than just stop loop</span>
<span class="sd">        &quot;&quot;&quot;</span>       
        <span class="kn">import</span> <span class="nn">signal</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">localtime</span><span class="p">,</span> <span class="n">strftime</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="si">%s</span><span class="s">: Paused. Press return to resume, or type exit to quit: </span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">time</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;e&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sel</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;E&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Interrogation resumed.</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">time</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">gettag</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">lemmatag</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find tag for WordNet lemmatisation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="k">if</span> <span class="n">lemmatag</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;n&#39;</span> <span class="c"># same default as wordnet</span>
            <span class="c"># attempt to find tag from tregex query</span>
            <span class="n">tagfinder</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^[^A-Za-z]*([A-Za-z]*)&#39;</span><span class="p">)</span>
            <span class="n">tagchecker</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^[A-Z]{1,4}$&#39;</span><span class="p">)</span>
            <span class="n">treebank_tag</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">tagfinder</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">r&#39;\w&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">r&#39;\s&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">r&#39;\b&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tagchecker</span><span class="p">,</span> <span class="n">treebank_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">treebank_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;J&#39;</span><span class="p">):</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;a&#39;</span>
                <span class="k">elif</span> <span class="n">treebank_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;V&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">treebank_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;M&#39;</span><span class="p">):</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;v&#39;</span>
                <span class="k">elif</span> <span class="n">treebank_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;n&#39;</span>
                <span class="k">elif</span> <span class="n">treebank_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;R&#39;</span><span class="p">):</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;r&#39;</span>
        <span class="k">elif</span> <span class="n">lemmatag</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">lemmatag</span>
            <span class="n">tagchecker</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^[avrn]$&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tagchecker</span><span class="p">,</span> <span class="n">lemmatag</span><span class="p">):</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">: WordNet POS tag &quot;</span><span class="si">%s</span><span class="s">&quot; not recognised.</span><span class="se">\n</span><span class="s"> It must be:</span><span class="se">\n\n</span><span class="s"> &#39;</span> \
                    <span class="s">&#39;              a: (adjective)&#39;</span> \
                    <span class="s">&#39;              n: (noun)&#39;</span> \
                    <span class="s">&#39;              r: (adverb)&#39;</span> \
                    <span class="s">&#39;              v: (verb)</span><span class="se">\n\n</span><span class="s">Your selection: &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">lemmatag</span><span class="p">))</span>
                <span class="n">lemmatag</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="k">return</span> <span class="n">tag</span>
    
    <span class="k">def</span> <span class="nf">processwords</span><span class="p">(</span><span class="n">list_of_matches</span><span class="p">,</span> <span class="n">lemmatag</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalise matches from interrogations</span>

<span class="sd">        -lowercase</span>
<span class="sd">        -remove non alnum</span>
<span class="sd">        -tokenise if phrases</span>
<span class="sd">        -put together with slashes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_of_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">list_of_matches</span><span class="p">]</span>
        <span class="c"># remove nonwords, strip . to normalise &quot;dr.&quot;</span>
        <span class="k">if</span> <span class="n">translated_option</span> <span class="o">!=</span> <span class="s">&#39;o&#39;</span> <span class="ow">and</span> <span class="n">translated_option</span> <span class="o">!=</span> <span class="s">&#39;u&#39;</span><span class="p">:</span>
            <span class="n">list_of_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">list_of_matches</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex_nonword_filter</span><span class="p">,</span> <span class="n">w</span><span class="p">)]</span>
    
        <span class="n">list_of_matches</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        
        <span class="c"># tokenise if multiword:</span>
        <span class="k">if</span> <span class="n">phrases</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">n_gramming</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">nltk</span> <span class="kn">import</span> <span class="n">word_tokenize</span> <span class="k">as</span> <span class="n">word_tokenize</span>
            <span class="n">list_of_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">list_of_matches</span><span class="p">]</span>

        <span class="c"># this is just for plaintext ... should convert to unicode on file open</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s">&#39;plaintext&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">list_of_matches</span> <span class="o">=</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;ignore&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">list_of_matches</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dependency</span> <span class="ow">and</span> <span class="n">exclude</span> <span class="ow">and</span> <span class="s">&#39;w&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">list_of_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">list_of_matches</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">exclude</span><span class="p">[</span><span class="s">&#39;w&#39;</span><span class="p">],</span> <span class="n">w</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">lemmatise</span> <span class="ow">or</span> <span class="s">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dependency</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">gettag</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">lemmatag</span> <span class="o">=</span> <span class="n">lemmatag</span><span class="p">)</span>
                <span class="n">lemmata</span> <span class="o">=</span> <span class="n">lemmatiser</span><span class="p">(</span><span class="n">list_of_matches</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
                <span class="n">tups</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">list_of_matches</span><span class="p">,</span> <span class="n">lemmata</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tups</span><span class="p">:</span>
                    <span class="n">single_result</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">exclude</span> <span class="ow">and</span> <span class="s">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">exclude</span><span class="p">[</span><span class="s">&#39;l&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">):</span>
                            <span class="k">continue</span>
                    <span class="k">if</span> <span class="s">&#39;w&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                        <span class="n">single_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                        <span class="n">single_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="c"># bad fix:</span>
                    <span class="c"># this currently says, if pos in show, there must only be pos ...</span>
                    <span class="k">if</span> <span class="s">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">lemmatise</span><span class="p">:</span>
                            <span class="n">single_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">single_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

                    <span class="n">single_result</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">single_result</span><span class="p">)</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_result</span><span class="p">)</span>
                <span class="n">list_of_matches</span> <span class="o">=</span> <span class="n">res</span>

        <span class="k">if</span> <span class="n">titlefilter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dependency</span><span class="p">:</span>
            <span class="n">list_of_matches</span> <span class="o">=</span> <span class="n">titlefilterer</span><span class="p">(</span><span class="n">list_of_matches</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spelling</span><span class="p">:</span>
            <span class="n">list_of_matches</span> <span class="o">=</span> <span class="n">convert_spelling</span><span class="p">(</span><span class="n">list_of_matches</span><span class="p">,</span> <span class="n">spelling</span> <span class="o">=</span> <span class="n">spelling</span><span class="p">)</span>

        
        <span class="c"># turn every result into a single string again if need be:</span>
        <span class="k">if</span> <span class="n">phrases</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">list_of_matches</span><span class="p">:</span>
                <span class="n">joined</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">list_of_matches</span>

    <span class="k">def</span> <span class="nf">lemmatiser</span><span class="p">(</span><span class="n">list_of_words</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;take a list of unicode words and a tag and return a lemmatised list.&quot;&quot;&quot;</span>
        
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">list_of_words</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">phrases</span><span class="p">:</span>
                <span class="c"># just get the rightmost word</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="k">if</span> <span class="n">translated_option</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">taglemma</span><span class="p">:</span>
                    <span class="n">word</span> <span class="o">=</span> <span class="n">taglemma</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">word</span> <span class="o">==</span> <span class="s">&#39;x&#39;</span><span class="p">:</span>
                        <span class="n">word</span> <span class="o">=</span> <span class="s">&#39;Other&#39;</span>
            <span class="c"># only use wordnet lemmatiser when appropriate</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">dependency</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">wordlist</span><span class="p">:</span>
                    <span class="n">word</span> <span class="o">=</span> <span class="n">wordlist</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">lmtzr</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
            <span class="c"># do the manual_lemmatisation</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">wordlist</span><span class="p">:</span>
                    <span class="n">word</span> <span class="o">=</span> <span class="n">wordlist</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">phrases</span><span class="p">:</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">titlefilterer</span><span class="p">(</span><span class="n">list_of_matches</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dictionaries.wordlists</span> <span class="kn">import</span> <span class="n">wordlists</span>
        <span class="n">badwords</span> <span class="o">=</span> <span class="n">wordlists</span><span class="o">.</span><span class="n">titles</span> <span class="o">+</span> <span class="n">wordlists</span><span class="o">.</span><span class="n">closedclass</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">list_of_matches</span><span class="p">:</span>
            <span class="n">head</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">non_head</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">title_stripped</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[:</span><span class="n">non_head</span><span class="p">]</span> <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">badwords</span><span class="p">]</span>
            <span class="n">title_stripped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title_stripped</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">convert_spelling</span><span class="p">(</span><span class="n">list_of_matches</span><span class="p">,</span> <span class="n">spelling</span> <span class="o">=</span> <span class="s">&#39;US&#39;</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dictionaries.word_transforms</span> <span class="kn">import</span> <span class="n">usa_convert</span>
        <span class="k">if</span> <span class="n">spelling</span> <span class="o">==</span> <span class="s">&#39;UK&#39;</span><span class="p">:</span>
            <span class="n">usa_convert</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">usa_convert</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">list_of_matches</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">phrases</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">usa_convert</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">distancer</span><span class="p">(</span><span class="n">lks</span><span class="p">,</span> <span class="n">lk</span><span class="p">):</span>
        <span class="s">&quot;determine number of jumps to root&quot;</span>      
        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># get the gov index, stop when it&#39;s zero</span>
        <span class="n">root_found</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">root_found</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">link_to_check</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lks</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">dependent</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">lk</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="n">root_found</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
                <span class="c">#link_to_check = lk</span>
            <span class="n">gov_index</span> <span class="o">=</span> <span class="n">link_to_check</span><span class="o">.</span><span class="n">governor</span><span class="o">.</span><span class="n">idx</span>
            <span class="k">if</span> <span class="n">gov_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">root_found</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">29</span><span class="p">:</span>
                    <span class="n">root_found</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
                <span class="n">link_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lks</span> <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">dependent</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">gov_index</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">link_to_check</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">link_to_check</span> <span class="o">=</span> <span class="n">link_to_check</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">dep_searcher</span><span class="p">(</span><span class="n">sents</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        search corenlp dependency parse</span>
<span class="sd">        1. search for &#39;search&#39; keyword arg</span>
<span class="sd">           governor</span>
<span class="sd">           dependent</span>
<span class="sd">           function</span>
<span class="sd">           pos</span>
<span class="sd">           lemma</span>
<span class="sd">           word</span>
<span class="sd">           index</span>

<span class="sd">        2. exclude entries if need be</span>

<span class="sd">        3. return &#39;/&#39;-sep list of &#39;show&#39; keyword arg:</span>
<span class="sd">           governor</span>
<span class="sd">           dependent</span>
<span class="sd">           function</span>
<span class="sd">           pos</span>
<span class="sd">           lemma</span>
<span class="sd">           word</span>
<span class="sd">           index</span>
<span class="sd">           distance</span>
<span class="sd">           </span>
<span class="sd">           ... or just return int count.</span>
<span class="sd">           &quot;&quot;&quot;</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sents</span><span class="p">:</span>
            <span class="n">lks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="n">get_deps</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dep_type</span><span class="p">)</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">tokens</span>
            <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">pat</span> <span class="o">=</span> <span class="n">filtermaker</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;g&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">governor</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
                            <span class="n">lks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_token_by_id</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">dependent</span><span class="o">.</span><span class="n">idx</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;d&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">dependent</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
                            <span class="n">lks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_token_by_id</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">governor</span><span class="o">.</span><span class="n">idx</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;f&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
                            <span class="n">lks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_token_by_id</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">dependent</span><span class="o">.</span><span class="n">idx</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;p&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">pos</span><span class="p">):</span>
                            <span class="n">lks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;l&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">lemma</span><span class="p">):</span>
                            <span class="n">lks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;w&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">word</span><span class="p">):</span>
                            <span class="n">lks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;i&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">id</span><span class="p">)):</span>
                            <span class="n">lks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>

            <span class="c"># only return results if all conditions are met</span>
            <span class="k">if</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">counted</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">lks</span><span class="p">)</span>
                <span class="n">lks</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">counted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>

            <span class="n">lks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lks</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex_nonword_filter</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">word</span><span class="p">)]))</span>

            <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">exclude</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">pat</span> <span class="o">=</span> <span class="n">filtermaker</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">lks</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;g&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">governor</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
                                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_token_by_id</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">governor</span><span class="o">.</span><span class="n">idx</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;d&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">dependent</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
                                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_token_by_id</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">dependent</span><span class="o">.</span><span class="n">idx</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;f&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
                                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_token_by_id</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">dependent</span><span class="o">.</span><span class="n">idx</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;p&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">pos</span><span class="p">):</span>
                                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;l&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">lemma</span><span class="p">):</span>
                                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;w&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">word</span><span class="p">):</span>
                                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;i&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">id</span><span class="p">)):</span>
                                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">excludemode</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">counted</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">to_remove</span><span class="p">)</span>
                    <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">counted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exclude</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">lks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="k">if</span> <span class="n">only_count</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lks</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c"># figure out what to show</span>
            <span class="k">for</span> <span class="n">lk</span> <span class="ow">in</span> <span class="n">lks</span><span class="p">:</span>
                <span class="n">single_result</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">deps</span><span class="o">.</span><span class="n">get_node_by_idx</span><span class="p">(</span><span class="n">lk</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

                <span class="k">if</span> <span class="s">&#39;w&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                    <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;none&#39;</span>
                    <span class="k">if</span> <span class="n">lemmatise</span><span class="p">:</span>
                        <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lk</span><span class="o">.</span><span class="n">lemma</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lk</span><span class="o">.</span><span class="n">word</span>

                <span class="k">if</span> <span class="s">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                    <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;l&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lk</span><span class="o">.</span><span class="n">lemma</span>

                <span class="k">if</span> <span class="s">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                    <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;none&#39;</span>
                    <span class="n">postag</span> <span class="o">=</span> <span class="n">lk</span><span class="o">.</span><span class="n">pos</span>
                    <span class="k">if</span> <span class="n">lemmatise</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">postag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">taglemma</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">taglemma</span><span class="p">[</span><span class="n">postag</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">postag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">postag</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;p&#39;</span><span class="p">]:</span>
                        <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;p&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;none&#39;</span>

                <span class="k">if</span> <span class="s">&#39;f&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                    <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;none&#39;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">dependent</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">lk</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                            <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">type</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;f&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;root&#39;</span>

                <span class="k">if</span> <span class="s">&#39;g&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                    <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;none&#39;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">dependent</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">lk</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">get_token_by_id</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">governor</span><span class="o">.</span><span class="n">idx</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">lemmatise</span><span class="p">:</span>                          
                                        <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_token_by_id</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">governor</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">lemma</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">governor</span><span class="o">.</span><span class="n">text</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;root&#39;</span>
                            <span class="k">break</span>

                <span class="k">if</span> <span class="s">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                    <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;none&#39;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">governor</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">lk</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">get_token_by_id</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">dependent</span><span class="o">.</span><span class="n">idx</span><span class="p">):</span>       
                                <span class="k">if</span> <span class="n">lemmatise</span><span class="p">:</span>
                                    <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_token_by_id</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">dependent</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">lemma</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">dependent</span><span class="o">.</span><span class="n">text</span>
                            <span class="k">break</span>

                <span class="k">if</span> <span class="s">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                    <span class="n">all_lks</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">links</span><span class="p">]</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="n">distancer</span><span class="p">(</span><span class="n">all_lks</span><span class="p">,</span> <span class="n">lk</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">distance</span><span class="p">:</span>
                        <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;-1&#39;</span>

                <span class="k">if</span> <span class="s">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                    <span class="n">single_result</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lk</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">only_count</span><span class="p">:</span>
                    
                    <span class="c"># add them in order</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_result</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="s">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">tok_by_list</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">list_of_toks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;search for regex in plaintext corpora&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">list_of_toks</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">tok_ngrams</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">list_of_toks</span><span class="p">,</span> <span class="n">split_contractions</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
        <span class="k">global</span> <span class="n">gramsize</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">ngrams</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># if it&#39;s not a compiled regex</span>
        <span class="n">list_of_toks</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_of_toks</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex_nonword_filter</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">split_contractions</span><span class="p">:</span>
            <span class="n">list_of_toks</span> <span class="o">=</span> <span class="n">unsplitter</span><span class="p">(</span><span class="n">list_of_toks</span><span class="p">)</span>
            
            <span class="c">#list_of_toks = [x for x in list_of_toks if &quot;&#39;&quot; not in x]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_of_toks</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">the_gram</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_of_toks</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">gramsize</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">the_gram</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="c">#if query != &#39;any&#39;:</span>
                <span class="c">#    if not any(re.search(query, w) is True for w in the_gram):</span>
                <span class="c">#        continue</span>
                <span class="n">ngrams</span><span class="p">[</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">the_gram</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c"># turn counter into list of results</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ngrams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">tok_by_reg</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">list_of_toks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;search for regex in plaintext corpora&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">comped</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="kn">import</span> <span class="nn">sys</span>
            <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span>
                          <span class="n">exc_traceback</span><span class="p">)</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">thetime</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Query </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thetime</span><span class="p">,</span> <span class="n">error_message</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&#39;Bad query&#39;</span>

        <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">list_of_toks</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">comped</span><span class="p">,</span> <span class="n">m</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">matches</span>

    <span class="k">def</span> <span class="nf">plaintext_regex_search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">plaintext_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;search for regex in plaintext corpora&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#if not pattern.startswith(r&#39;\b&#39;) and not pattern.endswith(r&#39;\b&#39;):</span>
            <span class="c">#pattern = r&#39;\b&#39; + pattern + &#39;\b&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">compiled_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="kn">import</span> <span class="nn">sys</span>
            <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span>
                          <span class="n">exc_traceback</span><span class="p">)</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">thetime</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Query </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thetime</span><span class="p">,</span> <span class="n">error_message</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&#39;Bad query&#39;</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">compiled_pattern</span><span class="p">,</span> <span class="n">plaintext_data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">matches</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="n">matches</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">matches</span>

    <span class="k">def</span> <span class="nf">plaintext_simple_search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">plaintext_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;search for tokens in plaintext corpora&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="kn">import</span> <span class="nn">sys</span>
            <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span>
                          <span class="n">exc_traceback</span><span class="p">)</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">thetime</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Query </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thetime</span><span class="p">,</span> <span class="n">error_message</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&#39;Bad query&#39;</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">case_sensitive</span><span class="p">:</span>
                <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\b&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="s">r&#39;\b&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\b&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="s">r&#39;\b&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">any_plaintext_word</span><span class="p">:</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">plaintext_data</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">plaintext_data</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">get_speaker_names_from_xml_corpus</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># parsing html with regular expression! :)</span>
        <span class="n">speakid</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;&lt;speakername&gt;[\s\n]*?([^\s\n]+)[\s\n]*?&lt;.speakername&gt;&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
                    <span class="n">txt</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">speakid</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">slow_tregex</span><span class="p">(</span><span class="n">sents</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;do the speaker-specific version of tregex queries&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">bs4</span>
        <span class="c"># first, put the relevant trees into temp file</span>
        <span class="k">if</span> <span class="s">&#39;outname&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">to_open</span> <span class="o">=</span> <span class="s">&#39;tmp-</span><span class="si">%s</span><span class="s">.txt&#39;</span> <span class="o">%</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_open</span> <span class="o">=</span> <span class="s">&#39;tmp.txt&#39;</span>
        <span class="n">to_write</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">sent</span><span class="o">.</span><span class="n">_parse_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">sents</span> <span class="k">if</span> <span class="n">sent</span><span class="o">.</span><span class="n">parse_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">to_open</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_write</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">tregex_engine</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> 
                            <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-o&#39;</span><span class="p">,</span> <span class="s">&#39;-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">translated_option</span><span class="p">],</span> 
                            <span class="n">corpus</span> <span class="o">=</span> <span class="n">to_open</span><span class="p">,</span>
                            <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">to_open</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">get_deps</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">dep_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dep_type</span> <span class="o">==</span> <span class="s">&#39;basic-dependencies&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sentence</span><span class="o">.</span><span class="n">basic_dependencies</span>
        <span class="k">if</span> <span class="n">dep_type</span> <span class="o">==</span> <span class="s">&#39;collapsed-dependencies&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sentence</span><span class="o">.</span><span class="n">collapsed_dependencies</span>
        <span class="k">if</span> <span class="n">dep_type</span> <span class="o">==</span> <span class="s">&#39;collapsed-ccprocessed-dependencies&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sentence</span><span class="o">.</span><span class="n">collapsed_ccprocessed_dependencies</span>

    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="n">sents</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get a bunch of frequencies on interpersonal phenomena&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">re</span>  
        <span class="c"># first, put the relevant trees into temp file</span>
        <span class="k">if</span> <span class="s">&#39;outname&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">to_open</span> <span class="o">=</span> <span class="s">&#39;tmp-</span><span class="si">%s</span><span class="s">.txt&#39;</span> <span class="o">%</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_open</span> <span class="o">=</span> <span class="s">&#39;tmp.txt&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">to_open</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">sents</span><span class="p">:</span>
                <span class="n">statsmode_results</span><span class="p">[</span><span class="s">&#39;Sentences&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sent</span><span class="o">.</span><span class="n">parse_string</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;ignore&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">deps</span> <span class="o">=</span> <span class="n">get_deps</span><span class="p">(</span><span class="n">sent</span><span class="p">,</span> <span class="n">dep_type</span><span class="p">)</span>
                <span class="n">numpass</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">links</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;pass&#39;</span><span class="p">)])</span>
                <span class="n">statsmode_results</span><span class="p">[</span><span class="s">&#39;Passives&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">numpass</span>
                <span class="n">statsmode_results</span><span class="p">[</span><span class="s">&#39;Tokens&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sent</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span>
                <span class="n">statsmode_results</span><span class="p">[</span><span class="s">&#39;Words&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">sent</span><span class="o">.</span><span class="n">tokens</span> <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()])</span>
                <span class="c">#statsmode_results[&#39;Unique words&#39;] += len(set([w.word.lower() for w in sent.tokens if w.word.isalnum()]))</span>
                <span class="c">#statsmode_results[&#39;Unique lemmata&#39;] += len(set([w.lemma.lower() for w in sent.tokens if w.word.isalnum()]))</span>

        <span class="c"># count moods via trees          (/\?/ !&lt; __)</span>
        <span class="kn">from</span> <span class="nn">dictionaries.process_types</span> <span class="kn">import</span> <span class="n">processes</span>
        <span class="kn">from</span> <span class="nn">corpkit.other</span> <span class="kn">import</span> <span class="n">as_regex</span>
        <span class="n">tregex_qs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Imperative&#39;</span><span class="p">:</span> <span class="s">r&#39;ROOT &lt; (/(S|SBAR)/ &lt; (VP !&lt; VBD !&lt; VBG !$ NP !$ SBAR &lt; NP !$-- S !$-- VP !$ VP)) !&lt;&lt; (/\?/ !&lt; __) !&lt;&lt;- /-R.B-/ !&lt;&lt;, /(?i)^(-l.b-|hi|hey|hello|oh|wow|thank|thankyou|thanks|welcome)$/&#39;</span><span class="p">,</span>
                     <span class="c">#&#39;Open interrogative&#39;: r&#39;ROOT &lt; SBARQ &lt;&lt;- (/\?/ !&lt; __)&#39;, </span>
                     <span class="c">#&#39;Closed interrogative&#39;: r&#39;ROOT ( &lt; (SQ &lt; (NP $+ VP)) &lt;&lt; (/\?/ !&lt; __) | &lt; (/(S|SBAR)/ &lt; (VP $+ NP)) &lt;&lt;- (/\?/ !&lt; __))&#39;,</span>
                     <span class="s">&#39;Unmodalised declarative&#39;</span><span class="p">:</span> <span class="s">r&#39;ROOT &lt; (S &lt; (/(NP|SBAR|VP)/ $+ (VP !&lt; MD)))&#39;</span><span class="p">,</span>
                     <span class="s">&#39;Modalised declarative&#39;</span><span class="p">:</span> <span class="s">r&#39;ROOT &lt; (S &lt; (/(NP|SBAR|VP)/ $+ (VP &lt; MD)))&#39;</span><span class="p">,</span>
                     <span class="s">&#39;Open class words&#39;</span><span class="p">:</span> <span class="s">r&#39;/^(NN|JJ|VB|RB)/ &lt; __&#39;</span><span class="p">,</span>
                     <span class="s">&#39;Closed class words&#39;</span><span class="p">:</span> <span class="s">r&#39;__ !&lt; __ !&gt; /^(NN|JJ|VB|RB)/&#39;</span><span class="p">,</span>
                     <span class="s">&#39;Clauses&#39;</span><span class="p">:</span> <span class="s">r&#39;/^S/ &lt; __&#39;</span><span class="p">,</span>
                     <span class="s">&#39;Interrogative&#39;</span><span class="p">:</span> <span class="s">r&#39;ROOT &lt;&lt; (/\?/ !&lt; __)&#39;</span><span class="p">,</span>
                     <span class="s">&#39;Mental processes&#39;</span><span class="p">:</span> <span class="s">r&#39;VP &gt; /^(S|ROOT)/ &lt;+(VP) (VP &lt;&lt;# /</span><span class="si">%s</span><span class="s">/)&#39;</span> <span class="o">%</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">processes</span><span class="o">.</span><span class="n">mental</span><span class="p">,</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="s">&#39;w&#39;</span><span class="p">),</span>
                     <span class="s">&#39;Verbal processes&#39;</span><span class="p">:</span> <span class="s">r&#39;VP &gt; /^(S|ROOT)/ &lt;+(VP) (VP &lt;&lt;# /</span><span class="si">%s</span><span class="s">/)&#39;</span> <span class="o">%</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">processes</span><span class="o">.</span><span class="n">verbal</span><span class="p">,</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="s">&#39;w&#39;</span><span class="p">),</span>
                     <span class="s">&#39;Relational processes&#39;</span><span class="p">:</span> <span class="s">r&#39;VP &gt; /^(S|ROOT)/ &lt;+(VP) (VP &lt;&lt;# /</span><span class="si">%s</span><span class="s">/)&#39;</span> <span class="o">%</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">processes</span><span class="o">.</span><span class="n">relational</span><span class="p">,</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="s">&#39;w&#39;</span><span class="p">)}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tregex_qs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">tregex_engine</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> 
                  <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-o&#39;</span><span class="p">,</span> <span class="s">&#39;-C&#39;</span><span class="p">],</span> 
                  <span class="n">corpus</span> <span class="o">=</span> <span class="n">to_open</span><span class="p">,</span>  
                  <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>
            <span class="n">statsmode_results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">global</span> <span class="n">numdone</span>
            <span class="n">numdone</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
                <span class="n">root</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
                <span class="n">tot_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">numdone</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">total_files</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tregex_qs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="k">if</span> <span class="s">&#39;outname&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">tot_string</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">],</span> <span class="n">tot_string</span><span class="p">)</span>
                <span class="n">animator</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">numdone</span><span class="p">,</span> <span class="n">tot_string</span><span class="p">,</span> <span class="o">**</span><span class="n">par_args</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;note&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;note&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;note&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">progvar</span><span class="o">.</span><span class="n">set</span><span class="p">((</span><span class="n">numdone</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_files</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tregex_qs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">/</span> <span class="n">denom</span><span class="p">)</span> <span class="o">+</span> <span class="n">startnum</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">to_open</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tabler</span><span class="p">(</span><span class="n">subcorpus_names</span><span class="p">,</span> <span class="n">list_of_dicts</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;make a word table showing num_rows results&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">subcorp</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subcorpus_names</span><span class="p">,</span> <span class="n">list_of_dicts</span><span class="p">):</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="n">num_rows</span><span class="p">)],</span> <span class="n">name</span> <span class="o">=</span> <span class="n">subcorp</span><span class="p">)</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">word_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">word_table</span>

    <span class="c"># a few things are off by default:</span>
    <span class="n">only_count</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">using_tregex</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">n_gramming</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">dependency</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">statsmode</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">split_con</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">search_iterable</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># determine what kind of data the corpus is</span>
    <span class="c"># this currently slows things down with huge corpora, </span>
    <span class="c"># so judge from folder name first  </span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-parsed&#39;</span><span class="p">):</span>
        <span class="n">datatype</span> <span class="o">=</span> <span class="s">&#39;parse&#39;</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-tokenised&#39;</span><span class="p">):</span>
        <span class="n">datatype</span> <span class="o">=</span> <span class="s">&#39;tokens&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">corpkit.process</span> <span class="kn">import</span> <span class="n">determine_datatype</span>
        <span class="n">datatype</span> <span class="o">=</span> <span class="n">determine_datatype</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c"># some empty lists we&#39;ll need</span>
    <span class="n">dicts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">allwords_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">regex_nonword_filter</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;[A-Za-z0-9:_]&quot;</span><span class="p">)</span>
    
    <span class="c"># fix up search</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">search</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">search</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;t&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">search</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;n&#39;</span><span class="p">)</span> \
                                              <span class="ow">and</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s">&#39;parse&#39;</span><span class="p">:</span>
            <span class="n">search_iterable</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s">&#39;any&#39;</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;.*&#39;</span>
        <span class="n">search</span> <span class="o">=</span> <span class="p">{</span><span class="n">search</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>

    <span class="n">possb</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="s">&#39;l&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="s">&#39;t&#39;</span><span class="p">,</span> <span class="s">&#39;f&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">possb</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;search argument &quot;</span><span class="si">%s</span><span class="s">&quot; unrecognised.&#39;</span> <span class="o">%</span> <span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;if &quot;t&quot; in search, it must be the only list item&#39;</span><span class="p">)</span>

    <span class="c"># fix up exclude naming conventions, convert lists to regex</span>
    <span class="n">fixed_exclude</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">exclude</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">corpkit.other</span> <span class="kn">import</span> <span class="n">as_regex</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="s">&#39;l&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">fixed_exclude</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fixed_exclude</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="n">fixed_exclude</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">search_iterable</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">show</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">show</span><span class="p">)</span> <span class="o">==</span> <span class="nb">unicode</span><span class="p">:</span>
        <span class="n">show</span> <span class="o">=</span> <span class="p">[</span><span class="n">show</span><span class="o">.</span><span class="n">lower</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">show</span><span class="p">):</span>
        <span class="n">show</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">possb</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="s">&#39;l&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="s">&#39;t&#39;</span><span class="p">,</span> <span class="s">&#39;f&#39;</span><span class="p">]</span>
    <span class="n">only_dep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;f&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">possb</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">show</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;show argument &quot;</span><span class="si">%s</span><span class="s">&quot; unrecognised.&#39;</span> <span class="o">%</span> <span class="n">show</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">show</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;if &quot;c&quot; in show, it must be the only list item&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">only_dep</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">show</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;If searching trees, show can not include: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">only_dep</span><span class="p">))</span>

    <span class="c"># Tregex option:</span>
    <span class="n">translated_option</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="kn">from</span> <span class="nn">corpkit.other</span> <span class="kn">import</span> <span class="n">as_regex</span>
    
    <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s">&#39;parse&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">using_tregex</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s">&#39;plaintext&#39;</span><span class="p">:</span>
        <span class="n">plaintext</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s">&#39;tokens&#39;</span><span class="p">:</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">True</span>


    <span class="k">if</span> <span class="n">using_tregex</span><span class="p">:</span>
        <span class="n">optiontext</span> <span class="o">=</span> <span class="s">&#39;Searching parse trees&#39;</span>
        <span class="k">if</span> <span class="s">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">dep_funct</span> <span class="o">=</span> <span class="n">slow_tregex</span>
            <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;u&#39;</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;__ &lt; (/</span><span class="si">%s</span><span class="s">/ !&lt; __)&#39;</span> <span class="o">%</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="s">&#39;line&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s">&#39;any&#39;</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;__ &lt; (/.?[A-Za-z0-9].?/ !&lt; __)&#39;</span>
        <span class="k">elif</span> <span class="s">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">dep_funct</span> <span class="o">=</span> <span class="n">slow_tregex</span>
            <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;o&#39;</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;__ &lt; (/</span><span class="si">%s</span><span class="s">/ !&lt; __)&#39;</span> <span class="o">%</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="s">&#39;line&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s">&#39;any&#39;</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;__ &lt; (/.?[A-Za-z0-9].?/ !&lt; __)&#39;</span>
        <span class="k">elif</span> <span class="s">&#39;w&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">dep_funct</span> <span class="o">=</span> <span class="n">slow_tregex</span>
            <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;t&#39;</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;/</span><span class="si">%s</span><span class="s">/ !&lt; __&#39;</span> <span class="o">%</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="s">&#39;line&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s">&#39;any&#39;</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;/.?[A-Za-z0-9].?/ !&lt; __&#39;</span>
        <span class="k">elif</span> <span class="s">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">dep_funct</span> <span class="o">=</span> <span class="n">slow_tregex</span>
            <span class="n">count_results</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">only_count</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;/</span><span class="si">%s</span><span class="s">/ !&lt; __&#39;</span>  <span class="o">%</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="s">&#39;line&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s">&#39;any&#39;</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;/.?[A-Za-z0-9].?/ !&lt; __&#39;</span>
        <span class="k">elif</span> <span class="s">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">dep_funct</span> <span class="o">=</span> <span class="n">slow_tregex</span>
            <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;t&#39;</span>
            <span class="n">lemmatise</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;/</span><span class="si">%s</span><span class="s">/ !&lt; __&#39;</span> <span class="o">%</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="s">&#39;line&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s">&#39;any&#39;</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;/.?[A-Za-z0-9].?/ !&lt; __&#39;</span>

    <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s">&#39;plaintext&#39;</span><span class="p">:</span>
        <span class="n">optiontext</span> <span class="o">=</span> <span class="s">&#39;Searching plaintext corpus&#39;</span>
        <span class="k">if</span> <span class="s">&#39;regex&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;regex&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;s&#39;</span>
            <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s">&#39;any&#39;</span><span class="p">:</span>
                <span class="n">any_plaintext_word</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">any_plaintext_word</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;r&#39;</span>
            <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s">&#39;any&#39;</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;[^\s]+&#39;</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="s">&#39;line&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span><span class="p">)</span>
            
    <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s">&#39;tokens&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;w&#39;</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;e&#39;</span>
                <span class="n">optiontext</span> <span class="o">=</span> <span class="s">&#39;Tokens via list.&#39;</span>
                <span class="n">dep_funct</span> <span class="o">=</span> <span class="n">tok_by_list</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;h&#39;</span>
                <span class="n">optiontext</span> <span class="o">=</span> <span class="s">&#39;Tokens via regular expression.&#39;</span>
                <span class="n">dep_funct</span> <span class="o">=</span> <span class="n">tok_by_reg</span>
        <span class="k">if</span> <span class="s">&#39;n&#39;</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;j&#39;</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">lemmatise</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">optiontext</span> <span class="o">=</span> <span class="s">&#39;Get ngrams from tokens.&#39;</span>
            <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s">&#39;any&#39;</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;.*&#39;</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="s">&#39;l&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">case_sensitive</span><span class="p">:</span>
                        <span class="n">query</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">query</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">traceback</span>
                    <span class="kn">import</span> <span class="nn">sys</span>
                    <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span>
                                  <span class="n">exc_traceback</span><span class="p">)</span>
                    <span class="n">error_message</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">thetime</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
                    <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Query </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thetime</span><span class="p">,</span> <span class="n">error_message</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s">&#39;Bad query&#39;</span>
            <span class="k">global</span> <span class="n">gramsize</span>
            <span class="k">if</span> <span class="s">&#39;gramsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">gramsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;gramsize&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gramsize</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">dep_funct</span> <span class="o">=</span> <span class="n">tok_ngrams</span>

    <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s">&#39;parse&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;n&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s">&#39;t&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;y&#39;</span>
            <span class="n">dependency</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">optiontext</span> <span class="o">=</span> <span class="s">&#39;Dependency querying...&#39;</span>
            <span class="n">dep_funct</span> <span class="o">=</span> <span class="n">dep_searcher</span>
            <span class="k">if</span> <span class="s">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="n">count_results</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">only_count</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="s">&#39;s&#39;</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;v&#39;</span>
            <span class="c">#using_tregex = True</span>
            <span class="n">statsmode</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">optiontext</span> <span class="o">=</span> <span class="s">&#39;Getting general stats.&#39;</span>
            <span class="n">dep_funct</span> <span class="o">=</span> <span class="n">get_stats</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">!=</span> <span class="s">&#39;parse&#39;</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;Need parsed corpus for this.&#39;</span>
                <span class="k">return</span>

    <span class="c"># initialise nltk lemmatiser only once</span>
    <span class="k">if</span> <span class="n">lemmatise</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">show</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dependency</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">nltk.stem.wordnet</span> <span class="kn">import</span> <span class="n">WordNetLemmatizer</span>
        <span class="n">lmtzr</span><span class="o">=</span><span class="n">WordNetLemmatizer</span><span class="p">()</span>

    <span class="k">if</span> <span class="s">&#39;n&#39;</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s">&#39;parse&#39;</span><span class="p">:</span>
            <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;n&#39;</span>
            <span class="n">using_tregex</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">optiontext</span> <span class="o">=</span> <span class="s">&#39;n-grams only.&#39;</span>
            <span class="n">n_gramming</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s">&#39;tokens&#39;</span><span class="p">:</span>
            <span class="n">translated_option</span> <span class="o">=</span> <span class="s">&#39;j&#39;</span>
            <span class="n">using_tregex</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="s">&#39;word&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dependency</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">boundaries</span> <span class="o">=</span> <span class="s">&#39;line&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span><span class="p">)</span>
            <span class="c">#query = r&#39;(?i)^(&#39; + &#39;|&#39;.join(query) + r&#39;)$&#39; </span>
        <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s">&#39;any&#39;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s">r&#39;.*&#39;</span>

    <span class="c"># see if fast tregex can be done instead of temp file slow way</span>
    <span class="n">can_do_fast</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">using_tregex</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">just_speakers</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">statsmode</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">can_do_fast</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">plaintext</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tregex_engine</span><span class="p">(</span><span class="n">corpus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">check_for_trees</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
                    <span class="n">decision</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">It appears that your corpus contains parse trees. If using a plaintext search option, your counts will likely be inaccurate.</span><span class="se">\n\n</span><span class="s">Hit enter to continue, or type &quot;exit&quot; to start again: &#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">decision</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;e&#39;</span><span class="p">):</span>
                        <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
                    <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Corpus &quot;</span><span class="si">%s</span><span class="s">&quot; contains parse trees. Use &quot;Trees&quot; option.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                    <span class="n">root</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    
    <span class="c"># if query is a special query, convert it:</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">search</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;t&#39;</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="s">&#39;any&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;l&#39;</span> <span class="ow">in</span> <span class="n">show</span> <span class="ow">or</span> <span class="s">&#39;w&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="n">search</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s">r&#39;/.?[A-Za-z0-9].?/ !&lt; __&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">search</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s">r&#39;__ &lt; (/.?[A-Za-z0-9].?/ !&lt; __)&#39;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;t&#39;</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="s">&#39;subjects&#39;</span><span class="p">:</span>
            <span class="n">search</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s">r&#39;__ &gt;&gt;# @NP&#39;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;t&#39;</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="s">&#39;processes&#39;</span><span class="p">:</span>
            <span class="n">search</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s">r&#39;/VB.?/ &gt;&gt;# ( VP &gt;+(VP) (VP !&gt; VP $ NP))&#39;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;t&#39;</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="s">&#39;modals&#39;</span><span class="p">:</span>
            <span class="n">search</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s">r&#39;MD &lt; __&#39;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;t&#39;</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="s">&#39;participants&#39;</span><span class="p">:</span>
            <span class="n">search</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s">r&#39;/(NN|PRP|JJ).?/ &gt;&gt;# (/(NP|ADJP)/ $ VP | &gt; VP)&#39;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;t&#39;</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="s">&#39;entities&#39;</span><span class="p">:</span>
            <span class="n">search</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s">r&#39;NP &lt;# NNP&#39;</span>
            <span class="n">titlefilter</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># check that there&#39;s nothing in the quicksave path</span>
    <span class="k">if</span> <span class="n">quicksave</span><span class="p">:</span>
        <span class="n">savedir</span> <span class="o">=</span> <span class="s">&#39;data/saved_interrogations&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quicksave</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.p&#39;</span><span class="p">):</span>
            <span class="n">quicksave</span> <span class="o">=</span> <span class="n">quicksave</span> <span class="o">+</span> <span class="s">&#39;.p&#39;</span>
        <span class="n">fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="n">quicksave</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fullpath</span><span class="p">):</span>
            <span class="c"># if the file exists, check if the query is pretty much the same</span>
            <span class="kn">from</span> <span class="nn">corpkit</span> <span class="kn">import</span> <span class="n">load_result</span>
            <span class="n">loaded</span> <span class="o">=</span> <span class="n">load_result</span><span class="p">(</span><span class="n">quicksave</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loaded</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="s">&#39;query&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">query</span> <span class="ow">and</span> \
            <span class="n">loaded</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">path</span> <span class="ow">and</span> \
            <span class="n">loaded</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="s">&#39;translated_option&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">translated_option</span> <span class="ow">and</span> \
            <span class="n">loaded</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="s">&#39;lemmatise&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">lemmatise</span> <span class="ow">and</span> \
            <span class="n">loaded</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="s">&#39;titlefilter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">titlefilter</span> <span class="ow">and</span> \
            <span class="n">loaded</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="s">&#39;spelling&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spelling</span> <span class="ow">and</span> \
            <span class="n">loaded</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="s">&#39;dep_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dep_type</span> <span class="ow">and</span> \
            <span class="n">loaded</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="s">&#39;function&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;interrogator&#39;</span><span class="p">:</span>
                <span class="n">dup_non_i</span> <span class="o">=</span> <span class="s">&#39;Duplicate&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dup_non_i</span> <span class="o">=</span> <span class="s">&#39;Non-identical&#39;</span>

            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fullpath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">quicksave</span><span class="p">:</span>
                <span class="n">dict_for_print</span> <span class="o">=</span> <span class="s">&#39;          &#39;</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">          &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">loaded</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> interrogation found in </span><span class="si">%s</span><span class="s">:</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> \
                       <span class="s">&#39;          You have the following options:</span><span class="se">\n\n</span><span class="s">&#39;</span> \
                       <span class="s">&#39;              a) save with a new name</span><span class="se">\n</span><span class="s">&#39;</span> \
                       <span class="s">&#39;              b) turn off &quot;quicksave&quot;</span><span class="se">\n</span><span class="s">&#39;</span> \
                       <span class="s">&#39;              c) return the results from </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> \
                       <span class="s">&#39;              d) delete </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> \
                       <span class="s">&#39;              e) Quickview </span><span class="si">%s</span><span class="s"> and then decide</span><span class="se">\n</span><span class="s">&#39;</span> \
                       <span class="s">&#39;              f) exit</span><span class="se">\n\n</span><span class="s">Your selection: &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">dup_non_i</span><span class="p">,</span> <span class="n">fullpath</span><span class="p">,</span> <span class="n">dict_for_print</span><span class="p">,</span> <span class="n">fullpath</span><span class="p">,</span> <span class="n">fullpath</span><span class="p">,</span> <span class="n">fullpath</span><span class="p">))</span>
                <span class="k">if</span> <span class="s">&#39;a&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">New save name: &#39;</span><span class="p">)</span>
                    <span class="n">quicksave</span> <span class="o">=</span> <span class="n">sel</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quicksave</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.p&#39;</span><span class="p">):</span>
                        <span class="n">quicksave</span> <span class="o">=</span> <span class="n">quicksave</span> <span class="o">+</span> <span class="s">&#39;.p&#39;</span>
                        <span class="n">fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="n">quicksave</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                    <span class="n">quicksave</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">elif</span> <span class="s">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">loaded</span>
                <span class="k">elif</span> <span class="s">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fullpath</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s">&#39;e&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">loaded</span><span class="o">.</span><span class="n">query</span>
                    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">print</span> <span class="n">loaded</span><span class="o">.</span><span class="n">results</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">print</span> <span class="n">loaded</span><span class="o">.</span><span class="n">totals</span>
                    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="k">elif</span> <span class="s">&#39;f&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;&#39;</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">as_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&#39;          Choice &quot;</span><span class="si">%s</span><span class="s">&quot; not recognised.&#39;</span> <span class="o">%</span> <span class="n">selection</span>

    <span class="c"># titlefiltering only works with phrases, so turn it on</span>
    <span class="k">if</span> <span class="n">titlefilter</span><span class="p">:</span>
        <span class="n">phrases</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">filtermaker</span><span class="p">(</span><span class="n">the_filter</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">the_filter</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">corpkit.other</span> <span class="kn">import</span> <span class="n">as_regex</span>
            <span class="n">the_filter</span> <span class="o">=</span> <span class="n">as_regex</span><span class="p">(</span><span class="n">the_filter</span><span class="p">,</span> <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">the_filter</span><span class="p">)</span>
            <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">traceback</span>
                <span class="kn">import</span> <span class="nn">sys</span>
                <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span>
                              <span class="n">exc_traceback</span><span class="p">)</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">thetime</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
                <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Filter </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thetime</span><span class="p">,</span> <span class="n">error_message</span><span class="p">)</span>
                <span class="k">return</span> <span class="s">&#39;Bad query&#39;</span>
        
        <span class="k">while</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
                <span class="k">print</span> <span class="n">the_filter</span>
                <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Invalid the_filter regular expression.&#39;</span> <span class="o">%</span> <span class="n">time</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">: filter regular expression &quot; </span><span class="si">%s</span><span class="s"> &quot; contains an error. You can either:</span><span class="se">\n\n</span><span class="s">&#39;</span> \
                <span class="s">&#39;              a) rewrite it now</span><span class="se">\n</span><span class="s">&#39;</span> \
                <span class="s">&#39;              b) exit</span><span class="se">\n\n</span><span class="s">Your selection: &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">the_filter</span><span class="p">))</span>
            <span class="k">if</span> <span class="s">&#39;a&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                <span class="n">the_filter</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">New regular expression: &#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\b&#39;</span> <span class="o">+</span> <span class="n">the_filter</span> <span class="o">+</span> <span class="s">r&#39;\b&#39;</span><span class="p">)</span>
                    <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">elif</span> <span class="s">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;&#39;</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="c"># dependencies:</span>
    <span class="c"># can&#39;t be phrases</span>
    <span class="c"># check if regex valid</span>
    <span class="c"># check if dep_type valid</span>
    <span class="k">if</span> <span class="n">dependency</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">translated_option</span> <span class="o">==</span> <span class="s">&#39;v&#39;</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">get_speaker_names_from_xml_corpus</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        
        <span class="n">phrases</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="n">allowed_dep_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;basic-dependencies&#39;</span><span class="p">,</span> <span class="s">&#39;collapsed-dependencies&#39;</span><span class="p">,</span> <span class="s">&#39;collapsed-ccprocessed-dependencies&#39;</span><span class="p">]</span>
        
        <span class="c"># allow a b and c shorthand</span>
        <span class="k">if</span> <span class="n">dep_type</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
            <span class="n">dep_type</span> <span class="o">=</span> <span class="n">allowed_dep_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dep_type</span> <span class="o">==</span> <span class="s">&#39;b&#39;</span><span class="p">:</span>
            <span class="n">dep_type</span> <span class="o">=</span> <span class="n">allowed_dep_types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dep_type</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">dep_type</span> <span class="o">=</span> <span class="n">allowed_dep_types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">while</span> <span class="n">dep_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_dep_types</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">: Dependency type &quot;</span><span class="si">%s</span><span class="s">&quot; not recognised. Must be one of:</span><span class="se">\n\n</span><span class="s">&#39;</span> \
                <span class="s">&#39;              a) basic-dependencies&#39;</span> \
                <span class="s">&#39;              b) collapsed-dependencies&#39;</span> \
                <span class="s">&#39;              c) collapsed-ccprocessed-dependencies</span><span class="se">\n\n</span><span class="s">Your selection: &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">dep_type</span><span class="p">))</span>
            <span class="k">if</span> <span class="s">&#39;a&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                <span class="n">dep_type</span> <span class="o">=</span> <span class="n">allowed_dep_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                <span class="n">dep_type</span> <span class="o">=</span> <span class="n">allowed_dep_types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                <span class="n">dep_type</span> <span class="o">=</span> <span class="n">allowed_dep_types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="c"># get list of subcorpora and sort them ... user input if no corpus found</span>
    <span class="n">got_corpus</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">while</span> <span class="n">got_corpus</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sorted_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">d</span><span class="p">))]</span>
            <span class="n">got_corpus</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">got_corpus</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">: Corpus directory not found: &quot; </span><span class="si">%s</span><span class="s"> &quot;. You can either:</span><span class="se">\n\n</span><span class="s">&#39;</span> \
                <span class="s">&#39;              a) enter a new corpus path</span><span class="se">\n</span><span class="s">&#39;</span> \
                <span class="s">&#39;              b) exit</span><span class="se">\n\n</span><span class="s">Your selection: &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
            <span class="k">if</span> <span class="s">&#39;a&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">New corpus path: &#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;&#39;</span>
                <span class="k">return</span>
    
    <span class="c"># treat as one large corpus if no subdirs found</span>
    <span class="n">one_big_corpus</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_dirs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c">#warnings.warn(&#39;\nNo subcorpora found in %s.\nUsing %s as corpus dir.&#39; % (path, path))</span>
        <span class="n">one_big_corpus</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># fails if in wrong dir!</span>
        <span class="n">sorted_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)]</span>

    <span class="c"># numerically sort subcorpora if the first can be an int</span>
    <span class="c"># could improve now with is_number, all</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">check</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sorted_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sorted_dirs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c"># if doing dependencies, make list of all files, and a progress bar</span>
    <span class="k">if</span> <span class="n">dependency</span> <span class="ow">or</span> <span class="n">plaintext</span> <span class="ow">or</span> <span class="n">tokens</span> <span class="ow">or</span> <span class="n">can_do_fast</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">all_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">sorted_dirs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">one_big_corpus</span><span class="p">:</span>
                <span class="n">subcorpus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subcorpus</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">if</span> <span class="n">dependency</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">subcorpus</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.xml&#39;</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">subcorpus</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)]</span>
            
            <span class="c"># skip files not containing speakers...</span>
            <span class="k">if</span> <span class="n">just_speakers</span><span class="p">:</span>
                <span class="n">rem</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subcorpus</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s">&#39;&lt;speakername&gt;&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">just_speakers</span><span class="p">):</span>
                        <span class="n">rem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">rem</span>

            <span class="n">all_files</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span><span class="p">,</span> <span class="n">files</span><span class="p">])</span>
        <span class="n">total_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">all_files</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">sorted_dirs</span> <span class="o">=</span> <span class="n">all_files</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="s">&#39;outname&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">dependency</span> <span class="ow">or</span> <span class="n">plaintext</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">:</span>
                    <span class="n">tstr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">total_files</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tstr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_dirs</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">translated_option</span> <span class="o">!=</span> <span class="s">&#39;v&#39;</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">animator</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">init</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">tot_string</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">total_files</span><span class="p">,</span> <span class="o">**</span><span class="n">par_args</span><span class="p">)</span>
                <span class="c">#p = TextProgressBar(total_files)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">animator</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">init</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">tot_string</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">total_files</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">par_args</span><span class="p">)</span>
                <span class="c">#p = TextProgressBar(total_files * 10)</span>
    
    <span class="c"># if tregex, make progress bar for each dir</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="s">&#39;outname&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">tstr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_dirs</span><span class="p">))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">animator</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">tot_string</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">,</span> <span class="n">init</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_dirs</span><span class="p">),</span> <span class="o">**</span><span class="n">par_args</span><span class="p">)</span>

    <span class="c"># loop through each subcorpus</span>
    <span class="n">subcorpus_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c"># check for valid query. so ugly.</span>
    <span class="k">if</span> <span class="n">using_tregex</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">n_gramming</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">tregex_engine</span><span class="p">(</span><span class="n">corpus</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">query</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-t&#39;</span><span class="p">],</span> <span class="n">check_query</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s">&#39;Bad query&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dependency</span> <span class="ow">or</span> <span class="n">translated_option</span> <span class="o">==</span> <span class="s">&#39;r&#39;</span> <span class="ow">or</span> <span class="n">translated_option</span> <span class="o">==</span> <span class="s">&#39;h&#39;</span><span class="p">:</span>
            <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">translated_option</span> <span class="o">==</span> <span class="s">&#39;r&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">r&#39;\b&#39;</span><span class="p">):</span>
                            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">r&#39;\b&#39;</span><span class="p">):</span>
                            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">case_sensitive</span><span class="p">:</span>
                            <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\b&#39;</span> <span class="o">+</span> <span class="n">query</span> <span class="o">+</span> <span class="s">r&#39;\b&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\b&#39;</span> <span class="o">+</span> <span class="n">query</span> <span class="o">+</span> <span class="s">r&#39;\b&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">regex</span> <span class="o">=</span> <span class="n">query</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">case_sensitive</span><span class="p">:</span>
                        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
                <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">traceback</span>
                    <span class="kn">import</span> <span class="nn">sys</span>
                    <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span>
                                  <span class="n">exc_traceback</span><span class="p">)</span>
                    <span class="n">error_message</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">thetime</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
                    <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Query </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thetime</span><span class="p">,</span> <span class="n">error_message</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s">&quot;Bad query&quot;</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
                    <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Regular expression in query contains an error.&#39;</span> <span class="o">%</span> <span class="n">time</span>
                    <span class="k">return</span> <span class="s">&#39;Bad query&#39;</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">: Regular expression &quot; </span><span class="si">%s</span><span class="s"> &quot; contains an error. You can either:</span><span class="se">\n\n</span><span class="s">&#39;</span> \
                    <span class="s">&#39;              a) rewrite it now</span><span class="se">\n</span><span class="s">&#39;</span> \
                    <span class="s">&#39;              b) exit</span><span class="se">\n\n</span><span class="s">Your selection: &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span>
                <span class="k">if</span> <span class="s">&#39;a&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">New regular expression: &#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">case_sensitive</span><span class="p">:</span>
                            <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\b&#39;</span> <span class="o">+</span> <span class="n">query</span> <span class="o">+</span> <span class="s">r&#39;\b&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\b&#39;</span> <span class="o">+</span> <span class="n">query</span> <span class="o">+</span> <span class="s">r&#39;\b&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
                        <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                        <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">elif</span> <span class="s">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;&#39;</span>
                    <span class="k">return</span>

    <span class="c">#print list nicely</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">qtext</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="nb">unicode</span><span class="p">:</span>
        <span class="n">qtext</span> <span class="o">=</span> <span class="n">query</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">qtext</span> <span class="o">=</span> <span class="s">&#39;regex&#39;</span>

    <span class="c"># horrible, format dict query</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">search</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pprint</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">qtext</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">search</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">qtext</span> <span class="o">=</span> <span class="n">qtext</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;u&#39;&quot;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">                  &#39;</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">skipped_sents</span>
    <span class="n">skipped_sents</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># begin interrogation</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">printstatus</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s">: Beginning corpus interrogation: </span><span class="si">%s</span><span class="s">&quot;</span> \
           <span class="s">&quot;</span><span class="se">\n</span><span class="s">          Query: &#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">          </span><span class="si">%s</span><span class="s">&quot;</span> \
           <span class="s">&quot;</span><span class="se">\n</span><span class="s">          Interrogating corpus ... </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">qtext</span><span class="p">,</span> <span class="n">optiontext</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Interrogating corpus ...&#39;</span> <span class="o">%</span> <span class="n">time</span>
    <span class="k">if</span> <span class="n">root</span> <span class="ow">and</span> <span class="n">tk</span><span class="p">:</span>
        <span class="n">root</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">global</span> <span class="n">numdone</span>
    <span class="n">numdone</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_dirs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">using_tregex</span> <span class="ow">or</span> <span class="n">n_gramming</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">can_do_fast</span> <span class="ow">or</span> <span class="n">n_gramming</span><span class="p">:</span>
                <span class="n">subcorpus_name</span> <span class="o">=</span> <span class="n">d</span>
                <span class="n">subcorpus_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subcorpus_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">paralleling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="n">tstr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">],</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_dirs</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tstr</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">animator</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">tstr</span><span class="p">,</span> <span class="o">**</span><span class="n">par_args</span><span class="p">)</span>
                    <span class="c">#animator(p, index, **par_args)</span>
                    <span class="c">#p.animate(index)</span>
                <span class="k">if</span> <span class="n">root</span> <span class="ow">and</span> <span class="n">tk</span><span class="p">:</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">one_big_corpus</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Interrogating subcorpus: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">subcorpus_name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Interrogating corpus ... &#39;</span> <span class="o">%</span> <span class="n">time</span>
                    <span class="n">root</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s">&#39;note&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;note&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;note&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">progvar</span><span class="o">.</span><span class="n">set</span><span class="p">(((</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_dirs</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">)</span> <span class="o">+</span> <span class="n">startnum</span><span class="p">)</span>
                <span class="c"># get path to corpus/subcorpus</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_dirs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">subcorpus</span> <span class="o">=</span> <span class="n">path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">subcorpus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">subcorpus_name</span><span class="p">)</span>
        
                <span class="k">if</span> <span class="n">n_gramming</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="s">&#39;split_contractions&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;split_contractions&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                            <span class="n">split_con</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;split_contractions&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                            <span class="n">split_con</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="kn">from</span> <span class="nn">corpkit.keys</span> <span class="kn">import</span> <span class="n">ngrams</span>
                    <span class="k">if</span> <span class="s">&#39;blacklist&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">the_blacklist</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;blacklist&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">the_blacklist</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">if</span> <span class="s">&#39;gramsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">gramsz</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;gramsize&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">gramsz</span> <span class="o">=</span> <span class="mi">2</span>

                    <span class="n">spindle_out</span> <span class="o">=</span> <span class="n">ngrams</span><span class="p">(</span><span class="n">subcorpus</span><span class="p">,</span> <span class="n">reference_corpus</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                                                    <span class="n">blacklist</span> <span class="o">=</span> <span class="n">the_blacklist</span><span class="p">,</span>
                                                    <span class="n">printstatus</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                                                    <span class="n">clear</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                                                    <span class="n">lemmatise</span> <span class="o">=</span> <span class="n">lemmatise</span><span class="p">,</span> 
                                                    <span class="n">split_contractions</span> <span class="o">=</span> <span class="n">split_con</span><span class="p">,</span> 
                                                    <span class="n">whitelist</span> <span class="o">=</span> <span class="n">query</span><span class="p">,</span>
                                                    <span class="n">gramsize</span> <span class="o">=</span> <span class="n">gramsz</span>
                                                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">spindle_out</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">query</span> <span class="o">!=</span> <span class="s">&#39;any&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spindle_out</span><span class="p">[</span><span class="n">w</span><span class="p">]):</span>
                                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spindle_out</span><span class="p">[</span><span class="n">w</span><span class="p">]):</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

                <span class="c">#if tregex, search</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">statsmode</span><span class="p">:</span>
                        <span class="n">op</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-o&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="n">translated_option</span><span class="p">]</span>
                        <span class="n">q</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">tregex_engine</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="n">q</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">op</span><span class="p">,</span> 
                                           <span class="n">corpus</span> <span class="o">=</span> <span class="n">subcorpus</span><span class="p">,</span> <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                            <span class="k">return</span>
                    
                        <span class="c"># if just counting matches, just </span>
                        <span class="c"># add subcorpus name and count...</span>
                        <span class="k">if</span> <span class="n">only_count</span><span class="p">:</span>
                            <span class="n">count_results</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                            <span class="k">continue</span>

        <span class="c"># for dependencies, d[0] is the subcorpus name </span>
        <span class="c"># and d[1] is its file list ... </span>

        <span class="k">elif</span> <span class="n">dependency</span> <span class="ow">or</span> <span class="n">plaintext</span> <span class="ow">or</span> <span class="n">tokens</span> <span class="ow">or</span> <span class="n">statsmode</span> <span class="ow">or</span> <span class="n">can_do_fast</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="c">#if not root:</span>
                <span class="c">#p.animate(-1, str(0) + &#39;/&#39; + str(total_files))</span>
            <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
            <span class="n">statsmode_results</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">({</span><span class="s">&#39;Sentences&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;Passives&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;Tokens&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="n">subcorpus_name</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">subcorpus_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subcorpus_name</span><span class="p">)</span>
            <span class="n">fileset</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c">#for f in read_files:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fileset</span><span class="p">:</span>
                <span class="n">result_from_file</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="c"># pass the x/y argument for more updates </span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span> <span class="ow">and</span> <span class="n">translated_option</span> <span class="o">!=</span> <span class="s">&#39;v&#39;</span><span class="p">:</span>
                    <span class="n">tot_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">total_files</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s">&#39;outname&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">tot_string</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">],</span> <span class="n">tot_string</span><span class="p">)</span>
                    <span class="n">animator</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tot_string</span><span class="p">,</span> <span class="o">**</span><span class="n">par_args</span><span class="p">)</span>
                    <span class="c">#p.animate((c), tot_string)</span>
                <span class="k">if</span> <span class="n">root</span> <span class="ow">and</span> <span class="n">tk</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">statsmode</span><span class="p">:</span>
                    <span class="n">root</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s">&#39;note&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;note&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;note&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">progvar</span><span class="o">.</span><span class="n">set</span><span class="p">((((</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="n">total_files</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">)</span> <span class="o">+</span> <span class="n">startnum</span><span class="p">)</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">one_big_corpus</span><span class="p">:</span>
                            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Interrogating subcorpus: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">subcorpus_name</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Interrogating corpus ...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">)</span>
                <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">one_big_corpus</span><span class="p">:</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">subcorpus_name</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dependency</span> <span class="ow">or</span> <span class="n">can_do_fast</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">plaintext</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tokens</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">text</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                            <span class="kn">from</span> <span class="nn">corenlp_xml.document</span> <span class="kn">import</span> <span class="n">Document</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">corenlp_xml</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">print</span> <span class="s">&#39;Could not read file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">filepath</span>
                                <span class="k">continue</span>
                            <span class="c">#corenlp_xml = Beautifulcorenlp_xml(data, parse_only=justsents)  </span>
                            <span class="k">if</span> <span class="n">just_speakers</span><span class="p">:</span>  
                                <span class="n">sents</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">corenlp_xml</span><span class="o">.</span><span class="n">sentences</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">speakername</span> <span class="ow">in</span> <span class="n">just_speakers</span><span class="p">]</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">sents</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="c">#sents = [s for s in corenlp_xml.find_all(&#39;sentence&#39;) \</span>
                                <span class="c">#if s.speakername.text.strip() in just_speakers]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">sents</span> <span class="o">=</span> <span class="n">corenlp_xml</span><span class="o">.</span><span class="n">sentences</span>
                            <span class="c"># run whichever function has been called</span>
                            <span class="k">if</span> <span class="n">translated_option</span> <span class="o">==</span> <span class="s">&#39;y&#39;</span><span class="p">:</span>
                                <span class="n">result_from_file</span> <span class="o">=</span> <span class="n">dep_searcher</span><span class="p">(</span><span class="n">sents</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">result_from_file</span> <span class="o">=</span> <span class="n">dep_funct</span><span class="p">(</span><span class="n">sents</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">only_count</span><span class="p">:</span>
                                <span class="n">count_results</span><span class="p">[</span><span class="n">subcorpus_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_from_file</span>

                            <span class="c"># memory problems</span>
                            <span class="n">corenlp_xml</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">plaintext</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">translated_option</span> <span class="o">==</span> <span class="s">&#39;r&#39;</span><span class="p">:</span>
                            <span class="n">result_from_file</span> <span class="o">=</span> <span class="n">plaintext_regex_search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">translated_option</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
                            <span class="n">result_from_file</span> <span class="o">=</span> <span class="n">plaintext_simple_search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tokens</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">pickle</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">))</span>
                    <span class="c">#print data</span>
                    <span class="k">if</span> <span class="n">translated_option</span> <span class="o">==</span> <span class="s">&#39;h&#39;</span><span class="p">:</span>
                        <span class="n">result_from_file</span> <span class="o">=</span> <span class="n">tok_by_reg</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">translated_option</span> <span class="o">==</span> <span class="s">&#39;e&#39;</span><span class="p">:</span>
                        <span class="n">result_from_file</span> <span class="o">=</span> <span class="n">tok_by_list</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">translated_option</span> <span class="o">==</span> <span class="s">&#39;j&#39;</span><span class="p">:</span>
                        <span class="n">split_con</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">if</span> <span class="s">&#39;split_contractions&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;split_contractions&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                                <span class="n">split_con</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="n">result_from_file</span> <span class="o">=</span> <span class="n">tok_ngrams</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">split_contractions</span> <span class="o">=</span> <span class="n">split_con</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">result_from_file</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">statsmode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">only_count</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">result_from_file</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">statsmode</span> <span class="ow">and</span> <span class="s">&#39;c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c"># lowercaseing, encoding, lemmatisation, </span>
        <span class="c"># titlewords removal, usa_english, etc.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">statsmode</span><span class="p">:</span>
            <span class="n">processed_result</span> <span class="o">=</span> <span class="n">processwords</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">lemmatag</span> <span class="o">=</span> <span class="n">lemmatag</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">statsmode</span><span class="p">:</span>
            <span class="n">allwords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">processed_result</span><span class="p">)</span>
            <span class="n">dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="n">processed_result</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">statsmode</span><span class="p">:</span>
            <span class="n">dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statsmode_results</span><span class="p">)</span>
            <span class="n">allwords_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">statsmode_results</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">plaintext</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">paralleling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dependency</span> <span class="ow">or</span> <span class="n">plaintext</span> <span class="ow">or</span> <span class="n">tokens</span> <span class="ow">or</span> <span class="n">can_do_fast</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="n">tstr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">],</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">total_files</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tstr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_dirs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_dirs</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">tstr</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">animator</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_dirs</span><span class="p">),</span> <span class="n">tot_string</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">,</span> <span class="o">**</span><span class="n">par_args</span><span class="p">)</span>

            <span class="c">#p.animate(len(sorted_dirs))</span>
        <span class="k">if</span> <span class="s">&#39;note&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;note&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;note&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">progvar</span><span class="o">.</span><span class="n">set</span><span class="p">((</span><span class="mi">100</span> <span class="o">/</span> <span class="n">denom</span> <span class="o">+</span> <span class="n">startnum</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">and</span> <span class="n">tk</span><span class="p">:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c"># weird float div by 0 zero error here for plaintext</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">translated_option</span> <span class="o">!=</span> <span class="s">&#39;v&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">paralleling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="n">animator</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">par_args</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">animator</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="o">**</span><span class="n">par_args</span><span class="p">)</span>
                    <span class="c">#p.animate(total_files)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">paralleling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="n">animator</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">total_files</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">par_args</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">animator</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">total_files</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">par_args</span><span class="p">)</span>
                    <span class="c">#p.animate(total_files * 10)</span>
            <span class="k">if</span> <span class="s">&#39;note&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;note&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;note&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">progvar</span><span class="o">.</span><span class="n">set</span><span class="p">((</span><span class="mi">100</span> <span class="o">/</span> <span class="n">denom</span> <span class="o">+</span> <span class="n">startnum</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">root</span> <span class="ow">and</span> <span class="n">tk</span><span class="p">:</span>
        <span class="n">root</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">have_ipython</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">root</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tk</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    
    <span class="c"># if only counting, get total total and finish up:</span>
    <span class="k">if</span> <span class="n">only_count</span><span class="p">:</span>
        <span class="n">stotals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">count_results</span><span class="p">)</span>
        <span class="n">stotals</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;Total&#39;</span> 
        <span class="n">outputnames</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;interrogation&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;query&#39;</span><span class="p">,</span> <span class="s">&#39;totals&#39;</span><span class="p">])</span>
        <span class="n">the_time_ended</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="c"># add option to named tuple</span>
        <span class="n">the_options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
                       <span class="s">&#39;search&#39;</span><span class="p">:</span> <span class="n">search</span><span class="p">,</span>
                       <span class="s">&#39;show&#39;</span><span class="p">:</span> <span class="n">show</span><span class="p">,</span>
                       <span class="s">&#39;function&#39;</span><span class="p">:</span> <span class="s">&#39;interrogator&#39;</span><span class="p">,</span>
                       <span class="s">&#39;datatype&#39;</span><span class="p">:</span> <span class="n">stotals</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                       <span class="s">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
                       <span class="s">&#39;exclude&#39;</span><span class="p">:</span> <span class="n">exclude</span><span class="p">,</span>
                       <span class="s">&#39;lemmatise&#39;</span><span class="p">:</span> <span class="n">lemmatise</span><span class="p">,</span>
                       <span class="s">&#39;titlefilter&#39;</span><span class="p">:</span> <span class="n">titlefilter</span><span class="p">,</span>
                       <span class="s">&#39;lemmatag&#39;</span><span class="p">:</span> <span class="n">lemmatag</span><span class="p">,</span>
                       <span class="s">&#39;spelling&#39;</span><span class="p">:</span> <span class="n">spelling</span><span class="p">,</span>
                       <span class="s">&#39;phrases&#39;</span><span class="p">:</span> <span class="n">phrases</span><span class="p">,</span>
                       <span class="s">&#39;dep_type&#39;</span><span class="p">:</span> <span class="n">dep_type</span><span class="p">,</span>
                       <span class="s">&#39;quicksave&#39;</span><span class="p">:</span> <span class="n">quicksave</span><span class="p">,</span>
                       <span class="s">&#39;time_started&#39;</span><span class="p">:</span> <span class="n">the_time_started</span><span class="p">,</span>
                       <span class="s">&#39;time_ended&#39;</span><span class="p">:</span> <span class="n">the_time_ended</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">the_options</span><span class="p">[</span><span class="s">&#39;translated_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translated_option</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">the_options</span><span class="p">[</span><span class="s">&#39;translated_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translated_options</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">outputnames</span><span class="p">(</span><span class="n">the_options</span><span class="p">,</span> <span class="n">stotals</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;outname&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stotals</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">stotals</span>
        <span class="k">if</span> <span class="n">have_ipython</span><span class="p">:</span>
            <span class="n">clear_output</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">quicksave</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stotals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">corpkit.other</span> <span class="kn">import</span> <span class="n">save_result</span>
                <span class="n">save_result</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">quicksave</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">printstatus</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Interrogation finished! </span><span class="si">%d</span><span class="s"> total occurrences.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">stotals</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tk</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;&#39;</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="c"># flatten and sort master list, in order to make a list of unique words</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">allwords</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">allwords_list</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;No results found, sorry.&#39;</span><span class="p">)</span>
    <span class="n">allwords</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">unique_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">allwords</span><span class="p">)</span>

    <span class="c">#make master reference_corpus</span>
    <span class="n">the_big_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c"># calculate results</span>
    <span class="c"># for every unique entry, find out how many times it appears per subcorpus</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">unique_words</span><span class="p">:</span>
        <span class="n">the_big_dict</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">each_dict</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">each_dict</span> <span class="ow">in</span> <span class="n">dicts</span><span class="p">]</span>
    
    <span class="c"># turn master dict into dataframe, sorted</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">the_big_dict</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">subcorpus_names</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">one_big_corpus</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ascending</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">one_big_corpus</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="s">&#39;Total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">tot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="s">&#39;Total&#39;</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">tot</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">&#39;Total&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c"># make totals branch</span>
    <span class="n">stotals</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stotals</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;Total&#39;</span>

    <span class="c"># make result into series if only one subcorpus</span>
    <span class="k">if</span> <span class="n">one_big_corpus</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df1_always_df</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">subcorpus_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">df</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>

    <span class="c"># if numerical colnames, sort numerically</span>
    <span class="k">if</span> <span class="n">show</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">show</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]:</span>
       <span class="n">intcols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)])</span>
       <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">intcols</span><span class="p">]</span>

    <span class="c"># add sort info for tk</span>
    <span class="k">if</span> <span class="n">tk</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span>
        <span class="n">df</span><span class="p">[</span><span class="s">&#39;tkintertable-order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))],</span> <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span>
    
    <span class="c"># print skipped sent information for distance_mode</span>
    <span class="k">if</span> <span class="n">printstatus</span> <span class="ow">and</span> <span class="s">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">show</span> <span class="ow">and</span> <span class="n">skipped_sents</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">          </span><span class="si">%d</span><span class="s"> sentences over 99 words skipped.</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">skipped_sents</span>
        
    <span class="c">#make results into named tuple</span>
    <span class="c"># add option to named tuple</span>
    <span class="n">the_time_ended</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="n">the_options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
                       <span class="s">&#39;search&#39;</span><span class="p">:</span> <span class="n">search</span><span class="p">,</span>
                       <span class="s">&#39;show&#39;</span><span class="p">:</span> <span class="n">show</span><span class="p">,</span>
                       <span class="s">&#39;datatype&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                       <span class="s">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
                       <span class="s">&#39;lemmatise&#39;</span><span class="p">:</span> <span class="n">lemmatise</span><span class="p">,</span>
                       <span class="s">&#39;titlefilter&#39;</span><span class="p">:</span> <span class="n">titlefilter</span><span class="p">,</span>
                       <span class="s">&#39;lemmatag&#39;</span><span class="p">:</span> <span class="n">lemmatag</span><span class="p">,</span>
                       <span class="s">&#39;function&#39;</span><span class="p">:</span> <span class="s">&#39;interrogator&#39;</span><span class="p">,</span>
                       <span class="s">&#39;spelling&#39;</span><span class="p">:</span> <span class="n">spelling</span><span class="p">,</span>
                       <span class="s">&#39;exclude&#39;</span><span class="p">:</span> <span class="n">exclude</span><span class="p">,</span>
                       <span class="s">&#39;phrases&#39;</span><span class="p">:</span> <span class="n">phrases</span><span class="p">,</span>
                       <span class="s">&#39;dep_type&#39;</span><span class="p">:</span> <span class="n">dep_type</span><span class="p">,</span>
                       <span class="s">&#39;quicksave&#39;</span><span class="p">:</span> <span class="n">quicksave</span><span class="p">,</span>
                       <span class="s">&#39;time_started&#39;</span><span class="p">:</span> <span class="n">the_time_started</span><span class="p">,</span>
                       <span class="s">&#39;time_ended&#39;</span><span class="p">:</span> <span class="n">the_time_ended</span><span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">the_options</span><span class="p">[</span><span class="s">&#39;translated_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translated_option</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">the_options</span><span class="p">[</span><span class="s">&#39;translated_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translated_options</span>

    <span class="n">outputnames</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;interrogation&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;query&#39;</span><span class="p">,</span> <span class="s">&#39;results&#39;</span><span class="p">,</span> <span class="s">&#39;totals&#39;</span><span class="p">])</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">outputnames</span><span class="p">(</span><span class="n">the_options</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">stotals</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">paralleling</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;outname&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">,</span> <span class="n">stotals</span><span class="p">)</span>
     
    <span class="k">if</span> <span class="n">have_ipython</span><span class="p">:</span>
        <span class="n">clear_output</span><span class="p">()</span>

    <span class="c"># warnings if nothing generated...</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">one_big_corpus</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df1_always_df</span><span class="p">:</span>
        <span class="n">num_diff_results</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">df1_always_df</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">one_big_corpus</span><span class="p">:</span>
        <span class="n">num_diff_results</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">df1_always_df</span> <span class="ow">and</span> <span class="n">one_big_corpus</span><span class="p">:</span>
        <span class="n">num_diff_results</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">df1_always_df</span> <span class="ow">and</span> <span class="n">one_big_corpus</span><span class="p">:</span>
        <span class="n">num_diff_results</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">num_diff_results</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;No results produced. Maybe your query needs work.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Interrogation produced no results, sorry.&#39;</span> <span class="o">%</span> <span class="n">time</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">stotals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;No totals produced. Maybe your query needs work.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Interrogation produced no results, sorry.&#39;</span> <span class="o">%</span> <span class="n">time</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">printstatus</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: Interrogation finished! </span><span class="si">%d</span><span class="s"> unique results, </span><span class="si">%d</span><span class="s"> total.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">num_diff_results</span><span class="p">,</span> <span class="n">stotals</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tk</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">quicksave</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stotals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">num_diff_results</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">corpkit.other</span> <span class="kn">import</span> <span class="n">save_result</span>
            <span class="n">save_result</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">quicksave</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">interrogator</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> 
                <span class="n">search</span> <span class="o">=</span> <span class="s">&#39;words&#39;</span><span class="p">,</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;any&#39;</span><span class="p">,</span> 
                <span class="n">show</span> <span class="o">=</span> <span class="s">&#39;words&#39;</span><span class="p">,</span>
                <span class="n">case_sensitive</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">lemmatise</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                <span class="n">titlefilter</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                <span class="n">lemmatag</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                <span class="n">spelling</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                <span class="n">phrases</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> 
                <span class="n">dep_type</span> <span class="o">=</span> <span class="s">&#39;basic-dependencies&#39;</span><span class="p">,</span>
                <span class="n">quicksave</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">printstatus</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                <span class="n">root</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">df1_always_df</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">just_speakers</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">corpkit-docs</a></h1>





<p>
<iframe src="https://ghbtns.com/github-btn.html?user=&repo=&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../corpkit.html">corpkit package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Daniel McDonald.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
    </div>

    

    
  </body>
</html>